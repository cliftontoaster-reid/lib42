permissions:
  contents: read
  checks: write

on:
  push:
    branches:
      - main
      - dev/*
      - feature/*
    paths:
      - "**.c"
      - "**.h"
      - CMakeLists.txt
      - .github/workflows/ci.yml
  pull_request:
    branches:
      - main
      - dev/*
    paths:
      - "**.c"
      - "**.h"
      - CMakeLists.txt
      - .github/workflows/ci.yml

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up CMake
        uses: lukka/get-cmake@latest

      - name: Generate Compilation Database
        run: |
          mkdir build
          cmake -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          cp build/compile_commands.json .

      - name: Trunk Code Quality
        uses: trunk-io/trunk-action@v1

  build:
    needs:
      - lint
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    concurrency:
      group: ci-${{ matrix.os }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v5

      - name: Clone Criterion and get commit hash
        id: criterion_commit
        run: |
          git clone --depth 1 https://github.com/Snaipe/Criterion.git /tmp/criterion
          cd /tmp/criterion
          echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Cache built Criterion
        uses: actions/cache@v4
        id: criterion_cache
        with:
          path: |
            /tmp/criterion/builddir
            /tmp/criterion/install
          key: criterion-${{ steps.criterion_commit.outputs.commit_hash }}

      - name: Set up CMake
        uses: lukka/get-cmake@latest

      - name: Set up Python (for Meson)
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install Meson and Ninja
        run: pip install meson ninja

      - name: Build Criterion
        if: steps.criterion_cache.outputs.cache-hit != 'true'
        run: |
          cd /tmp/criterion
          meson setup builddir --prefix=/usr/local
          meson compile -C builddir

      - name: Install Criterion
        run: |
          cd /tmp/criterion
          sudo meson install -C builddir

      - name: Update shared library cache (Linux)
        if: runner.os == 'Linux'
        run: sudo ldconfig

      - name: Configure CMake
        run: |
          mkdir build
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build (Linux / macOS)
        run: cmake --build build --config Release -- -j$(nproc)

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure  --output-junit test-results.xml

      - name: Upload Test Results
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/test-results.xml
          report_type: test_results

  codecov:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Clone Criterion and get commit hash
        id: criterion_commit
        run: |
          git clone --depth 1 https://github.com/Snaipe/Criterion.git /tmp/criterion
          cd /tmp/criterion
          echo "commit_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Cache built Criterion
        uses: actions/cache@v4
        id: criterion_cache
        with:
          path: |
            /tmp/criterion/builddir
            /tmp/criterion/install
          key: criterion-${{ steps.criterion_commit.outputs.commit_hash }}

      - name: Set up CMake
        uses: lukka/get-cmake@latest

      - name: Set up Python (for Meson)
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install Meson and Ninja
        run: pip install meson ninja

      - name: Build and Install Criterion
        if: steps.criterion_cache.outputs.cache-hit != 'true'
        run: |
          cd /tmp/criterion
          meson setup builddir --prefix=/usr/local
          meson compile -C builddir
          sudo $(which meson) install -C builddir
          sudo ldconfig

      - name: Configure CMake
        run: |
          mkdir build
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCODE_COVERAGE=ON

      - name: Build
        run: cmake --build build --config Release -- -j$(nproc)

      - name: Install lcov
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lcov

      - name: Generate Coverage Data
        run: |
          cd build
          ctest --output-on-failure
          geninfo . --output-filename coverage.info --ignore-errors mismatch --memory 0
          lcov --ignore-errors unused --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --list coverage.info || true

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          # For private repositories you must provide a CODECOV_TOKEN in repository secrets.
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/coverage.info
          flags: unittests
