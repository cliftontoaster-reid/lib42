permissions:
  contents: read
  checks: write

on:
  push:
    branches:
      - main
      - dev/*
      - feature/*
    paths:
      - "**.c"
      - "**.h"
      - CMakeLists.txt
      - .github/workflows/ci.yml
  pull_request:
    branches:
      - main
      - dev/*
    paths:
      - "**.c"
      - "**.h"
      - CMakeLists.txt
      - .github/workflows/ci.yml

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Trunk Code Quality
        uses: trunk-io/trunk-action@v1

  build:
    needs:
      - lint
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    concurrency:
      group: ci-${{ matrix.os }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v5

      - name: Set up CMake
        uses: lukka/get-cmake@latest

      - name: Set up Python (for Meson)
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Meson and Ninja
        run: pip install meson ninja

      - name: Build and Install Criterion (Linux / macOS)
        if: runner.os != 'Windows'
        run: |
          git clone --depth 1 https://github.com/Snaipe/Criterion.git /tmp/criterion
          cd /tmp/criterion
          meson setup builddir --prefix=/usr/local
          meson compile -C builddir
          sudo meson install -C builddir

      - name: Build and Install Criterion (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          git clone --depth 1 https://github.com/Snaipe/Criterion.git /tmp/criterion
          cd /tmp/criterion
          meson setup builddir --prefix="C:/Program Files/Criterion"
          meson compile -C builddir
          meson install -C builddir

      - name: Configure CMake
        run: |
          mkdir build
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build (Linux / macOS)
        if: runner.os != 'Windows'
        run: cmake --build build --config Release -- -j$(nproc)

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: cmake --build build --config Release -- /m

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure

  codecov:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up CMake
        uses: lukka/get-cmake@latest

      - name: Set up Python (for Meson)
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Meson and Ninja
        run: pip install meson ninja

      - name: Build and Install Criterion
        run: |
          git clone --depth 1 https://github.com/Snaipe/Criterion.git /tmp/criterion
          cd /tmp/criterion
          meson setup builddir --prefix=/usr/local
          meson compile -C builddir
          sudo meson install -C builddir

      - name: Configure CMake
        run: |
          mkdir build
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCODE_COVERAGE=ON

      - name: Build
        run: cmake --build build --config Release -- -j$(nproc)

      - name: Install lcov
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lcov

      - name: Generate Coverage Data
        run: |
          cd build
          ctest --output-on-failure
          # Use lcov to capture coverage data from build directory. geninfo can
          # be brittle; lcov --capture is more portable and avoids certain
          # warnings/mismatch errors.
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --list coverage.info || true

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          # For private repositories you must provide a CODECOV_TOKEN in repository secrets.
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/coverage.info
          flags: unittests
          name: codecov-ubuntu
